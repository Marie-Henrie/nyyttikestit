@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JsRuntime

<div class="modal fade show text-center" id="myModal" style="display:block; background-color: rgba(10,10,10,.8);"
     aria-modal="true" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Muokkaa Nyyttiä</h4>
                <button @onclick=@CloseModal class="btn"><i class="fa fa-times"></i></button>
            </div>

            <div class="modal-body">
                @if (loaded)
                {
                    <EditForm Model="pot" OnInvalidSubmit="PutPot">
                        <div class="form-floating">
                            <InputText class="form-control" id="floatingInput" placeholder="Luoja" @bind-Value="pot.Creator" />
                            <label for="floatingInput">Luoja</label>
                        </div>
                        <br />
                        <div class="form-floating">
                            <InputText class="form-control" id="floatingInput" placeholder="Aaterian nimi" @bind-Value="pot.DishName" />
                            <label for="floatingInput">Aterian nimi</label>
                        </div>
                        <br />
                        <div class="form-floating">
                            <InputText class="form-control" id="floatingInput" placeholder="Kuvaus" @bind-Value="pot.Description" />
                            <label for="floatingInput">Kuvaus</label>
                        </div>
                        <br />
                        @foreach (var t in selected_tags)
                        {
                            <p>@t.Name <button @onclick="(() => DeleteTag(t))" class="btn"><i class="fa fa-trash"></i></button></p>
                        }

                        <div class="dropdown">
                            <button class="button button-update fs-4 dropdown-toggle mb-2" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                Tagit
                            </button><ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                @foreach (var t in tags)
                                {
                                    <li><a class="dropdown-item" @onclick="(()=>SelectTag(t))">@t.Name</a></li>
                                }
                            </ul>
                        </div>

                        <div class="dropdown">
                            <button class="button button-update fs-4 dropdown-toggle mb-2" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                @buttontext
                            </button><ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
                                @foreach (var d in dishes)
                                {
                                    <li><a class="dropdown-item" @onclick="(()=>SelectDish(d))">@d.Name</a></li>
                                }
                            </ul>
                        </div>
                        <div class="d-grid">
                            <button class="button button-update fs-4" @onclick="PutPot">Päivitä</button>
                        </div>
                    </EditForm>
                }
                else
                {
                    <div class="mt-5">
                        <LoadingDot />
                    </div>
                }
            </div>
        </div>
    </div>
</div>


@code {
    [Parameter] public string guid { get; set; }

    //[Parameter] public EventCallback<Pot> createdPot { get; set; }

    [Parameter] public EventCallback<bool> OnClose { get; set; }
    [Parameter] public EventCallback<Pot> editedPot { get; set; }

    bool loaded = false;

    private string buttontext = "Valitse ruokalaji";

    public List<Tag> tags = new List<Tag>();

    public List<Course> dishes;

    public Course selected_course = null;

    public List<Tag> selected_tags = null;

    public Pot pot { get; set; }

    [Parameter] public Pot epot { get; set; }


    private bool missingFields = true;

    protected override async Task OnInitializedAsync()
    {
        pot = new Pot()
        {
            Description = epot.Description,
            Creator = epot.Creator,
            Course_Id = epot.Course_Id,
            DishName = epot.DishName,
            Pot_Id = epot.Pot_Id,
            Potluck = epot.Potluck
        };

        selected_tags = epot.Tags;

        tags = await Http.GetFromJsonAsync<List<Tag>>(APIEndpoints.s_Tags);
        dishes = await Http.GetFromJsonAsync<List<Course>>(APIEndpoints.s_Courses);

        selected_course = dishes.First(i => i.Id == epot.Course_Id);
        buttontext = dishes.First(i => i.Id == epot.Course_Id).Name;

        loaded = true;
    }

    private async Task PutPot()
    {
        PotDTO p = new PotDTO()
        {
            DishName = pot.DishName,
            Course_Id = selected_course.Id,
            Creator = pot.Creator,
            Pot_Id = pot.Pot_Id,
            Description = pot.Description,
            tag_ids = new List<int>()
        };
        pot.Tags = selected_tags;
        foreach (var t in selected_tags)
        {
            p.tag_ids.Add(t.Tag_Id);
        }



        string missingFields = "";

        if (string.IsNullOrWhiteSpace(pot.Creator)) missingFields += "\nNyytillä täytyy olla luoja.";
        if (string.IsNullOrWhiteSpace(pot.DishName)) missingFields += "\nAterialla täytyy olla nimi.";
        if (string.IsNullOrWhiteSpace(pot.Description)) missingFields += "\nNyytillä täytyy olla kuvaus.";
        if (selected_course != null) pot.Course_Id = selected_course.Id;
        else missingFields += "\nRuokalajia ei ole valittuna.";

        if (!string.IsNullOrEmpty(missingFields))
        {
            await JsRuntime.InvokeVoidAsync("alert", missingFields);
            return;
        }

        using var response = await Http.PutAsJsonAsync<PotDTO>($"{APIEndpoints.s_PostPot}/{guid}/{epot.Pot_Id}", p);

        if (response.IsSuccessStatusCode)
        {

            await editedPot.InvokeAsync(pot);
            await CloseModal();
            return;
        }
        //await JsRuntime.InvokeVoidAsync("alert", "Nyytti ei Päivitetty!");
        await CloseModal();
    }
    public virtual void SelectDish(Course d)
    {
        selected_course = d;
        buttontext = d.Name;
    }
    public virtual void SelectTag(Tag t)
    {
        if (selected_tags.Contains(t)) return;
        selected_tags.Add(t);

    }

    public virtual void DeleteTag(Tag t)
    {
        selected_tags.Remove(t);
    }

    private Task CloseModal()
    {
        return OnClose.InvokeAsync(false);
    }

}
